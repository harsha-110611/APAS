<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EEE Before - Flash Card Quiz</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; background:black; font-family:Arial,sans-serif; overflow:hidden; }
canvas { display:block; }

#beforeScreen { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; display:flex; align-items:center; justify-content:center; width:80%; max-width:750px; }
.cinematic-panel { background: rgba(255,255,255,0.9); border-radius:50px; padding:40px 60px; text-align:center; box-shadow:0 10px 35px rgba(0,0,0,0.35); }
.cinematic-text { font-size:18px; line-height:1.8; margin:10px 0; text-align:left; color:black; }

.button { position: relative; transition: all 0.3s ease-in-out; box-shadow:0px 10px 20px rgba(0,0,0,0.2); padding:0.5rem 1.25rem; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; gap:10px; font-weight:bold; border:3px solid #ffffff4d; outline-offset:3px; overflow:hidden; font-size:15px; cursor:pointer; margin-top:25px; user-select:none; display:none; }
#backBtn { background-color:#e74c3c; color:white; }
#startQuizBtn { background-color:#006bb3; color:white; }
.button:hover { transform: scale(1.05); border-color:#fff9; }
.button::before { content:""; position:absolute; width:100px; height:100%; background-image: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.8), rgba(255,255,255,0) 70%); top:0; left:-100px; opacity:0.6; }
.button:hover::before { animation: shine 1.5s ease-out infinite; }
@keyframes shine {0%{left:-100px;} 60%{left:100%;} to{left:100%;}}

/* --- Start of Roll Number Modal Styles --- */
#rollModal { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:200; display:none; }
.roll-box { background:#fff; padding:30px 40px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.4); }
.roll-box h2 { margin-bottom:15px; color:#333; }
.roll-box input { padding:10px; border-radius:8px; border:2px solid #ccc; width:80%; font-size:16px; margin-bottom:15px; }
.roll-box button { background:#006bb3; color:white; border:none; padding:10px 20px; border-radius:999px; font-weight:bold; cursor:pointer; position: relative; overflow:hidden; margin-top:10px; }
.roll-box button::before { content:""; position:absolute; width:100px; height:100%; background-image: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.8), rgba(255,255,255,0) 70%); top:0; left:-100px; opacity:0.6; }
.roll-box button:hover::before { animation: shine 1.5s ease-out infinite; }
#userDetails { margin-top:15px; font-weight:bold; color:#333; }
#proceedBtn { display:none; margin-top:10px; }
/* --- End of Roll Number Modal Styles --- */
</style>
</head>
<body>
<canvas id="c"></canvas>
<audio id="thunderSound" preload="auto">
  <source src="https://actions.google.com/sounds/v1/weather/thunder_crack.ogg" type="audio/ogg">
  <source src="https://actions.google.com/sounds/v1/weather/thunder_crack.mp3" type="audio/mpeg">
</audio>

<div id="beforeScreen">
  <div class="cinematic-panel">
    <h1 id="cinematicHeading"></h1>
    <div id="rulesContainer"></div>
    <div style="display:flex; gap:15px; justify-content:center; margin-top:25px;">
      <button class="button" id="backBtn">‚Üê Back</button>
      <button class="button" id="startQuizBtn">Start Quiz ‚Üí</button>
    </div>
  </div>
</div>

<!-- --- Start of Roll Number Modal HTML --- -->
<div id="rollModal">
  <div class="roll-box">
    <h2>Enter Your Roll Number</h2>
    <input type="text" id="rollInput" placeholder="e.g. 24F11A05XX" />
    <br/>
    <button id="submitRollBtn">Submit</button>
    <button id="proceedBtn">Proceed to Quiz ‚Üí</button>
    <p id="userDetails"></p>
  </div>
</div>
<!-- --- End of Roll Number Modal HTML --- -->

<!-- ‚úÖ Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ========== Supabase Init ==========
const supabaseUrl = "https://vjbdemwrqalpnjbjfsir.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqYmRlbXdycWFscG5qYmpmc2lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMjEzODgsImV4cCI6MjA3MTc5NzM4OH0.yigzQuQcI-MbHSYV04MZFoCp9iAYcIF2cGO2VMFgdfs";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ‚ö° Thunder Canvas
const canvas = document.getElementById("c"), ctx = canvas.getContext("2d");
let width, height;
function resize(){ width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; }
window.addEventListener("resize", resize); resize();

const cfg={segmentLen:18,jag:25,life:15,flashAlpha:0.25};
let bolts=[], flash=0;
function makeBolt(x1,y1,x2,y2){
  const segments=[{x:x1,y:y1}]; let curX=x1, curY=y1;
  const dx=x2-x1, dy=y2-y1, steps=Math.hypot(dx,dy)/cfg.segmentLen;
  for(let i=0;i<steps;i++){
    curX+=dx/steps+(Math.random()-0.5)*cfg.jag;
    curY+=dy/steps+(Math.random()-0.5)*cfg.jag;
    segments.push({x:curX,y:curY});
  }
  segments.push({x:x2,y:y2});
  return {segments, life: cfg.life};
}
function strikeAt(x,y){
  const angle=Math.random()*Math.PI*2, radius=150;
  const sx=x+Math.cos(angle)*radius, sy=y+Math.sin(angle)*radius;
  bolts.push(makeBolt(sx,sy,x,y));
}
function drawBolt(bolt, alpha){
  ctx.save(); ctx.globalCompositeOperation="lighter";
  ctx.lineWidth=6; ctx.shadowBlur=25; ctx.shadowColor="rgba(255,200,50,1)";
  ctx.beginPath(); ctx.moveTo(bolt.segments[0].x,bolt.segments[0].y);
  bolt.segments.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.strokeStyle=`rgba(255,200,50,${0.5*alpha})`; ctx.stroke();
  ctx.lineWidth=3; ctx.shadowBlur=10; ctx.shadowColor="rgba(255,230,100,1)";
  ctx.beginPath(); ctx.moveTo(bolt.segments[0].x,bolt.segments[0].y);
  bolt.segments.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.strokeStyle=`rgba(255,230,100,${0.9*alpha})`; ctx.stroke();
  ctx.lineWidth=1.5; ctx.shadowBlur=0;
  ctx.beginPath(); ctx.moveTo(bolt.segments[0].x,bolt.segments[0].y);
  bolt.segments.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.strokeStyle=`rgba(255,255,255,${1*alpha})`; ctx.stroke();
  ctx.restore();
}
function loop(){
  ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.fillRect(0,0,width,height);
  bolts.forEach((b,i)=>{ const alpha=b.life/cfg.life; drawBolt(b,alpha); b.life--; if(b.life<=0) bolts.splice(i,1); });
  if(flash>0){ ctx.fillStyle=`rgba(255,255,200,${flash})`; ctx.fillRect(0,0,width,height); flash-=0.02; }
  requestAnimationFrame(loop);
}
loop();
const thunderSound=document.getElementById("thunderSound");
canvas.addEventListener("mousemove", e=>{ strikeAt(e.clientX,e.clientY); flash=cfg.flashAlpha; thunderSound.currentTime=0; thunderSound.play(); });

// üé¨ Rules
const heading=document.getElementById("cinematicHeading");
const container=document.getElementById("rulesContainer");
const startBtn=document.getElementById("startQuizBtn");
const backBtn=document.getElementById("backBtn");

function typeWriter(el,text,speed,cb){ el.innerHTML=''; let i=0; function typing(){ if(i<text.length){ el.innerHTML+=text.charAt(i); i++; setTimeout(typing,speed);} else if(cb) cb(); } typing(); }

const rules=[
  "1. The user will have five questions.",
  "2. For each correct answer, the player will be awarded 2 points.",
  "3. For each incorrect answer, no points will be awarded.",
  "4. As for now the points are stored in the local storage,we will furtherly update them in a well defined DATA-BASE.",
  "5. For the user convenience and fun,user can play the QUIZ even they are out of attempts."
];

typeWriter(heading,"Before We Begin",100,function showRules(index=0){
  if(index<rules.length){
    const p=document.createElement("p"); p.className="cinematic-text"; container.appendChild(p);
    typeWriter(p,rules[index],40,()=>{ setTimeout(()=>showRules(index+1),400); });
  } else { startBtn.style.display='inline-flex'; backBtn.style.display='inline-flex'; }
});

backBtn.onclick = () => { window.location.href = "departments.html"; };

// --- Roll Number Modal + Supabase Integration ---
const rollModal = document.getElementById('rollModal');
const rollInput = document.getElementById('rollInput');
const submitBtn = document.getElementById('submitRollBtn');
const proceedBtn = document.getElementById('proceedBtn');
const userDetails = document.getElementById('userDetails');

startBtn.onclick = ()=> rollModal.style.display = "flex";

submitBtn.onclick = async () => {
  const roll = rollInput.value.trim().toUpperCase();
  if(!roll){ alert("Please enter your roll number."); return; }

  // Check if user exists
  const { data: existing, error: selectError } = await supabase
    .from("users")
    .select("*")
    .eq("roll_number", roll)
    .single();

  // If an error other than "no rows returned"
  if (selectError && selectError.code !== "PGRST116") {
    console.error("Select error:", selectError);
    alert("Error checking user.");
    return;
  }

  if (!existing) {
    // Create new user with defaults
    const { error: insertError } = await supabase
      .from("users")
      .insert([{ roll_number: roll, points: 0, attempts: 5 }]);

    if (insertError) {
      console.error("Insert error:", insertError);
      alert("Error creating user.");
      return;
    }

    userDetails.textContent = `Roll Number: ${roll} | Points: 0 | Attempts: 5`;
  } else {
    userDetails.textContent = `Roll Number: ${roll} | Points: ${existing.points} | Attempts: ${existing.attempts}`;
  }

  proceedBtn.style.display = "inline-block";
};

proceedBtn.onclick = () => {
  localStorage.setItem("rollNumber", rollInput.value.trim().toUpperCase());
  window.location.href = "eee-quiz.html";
};

rollInput.addEventListener("keydown", (e) => { if(e.key==="Enter") submitBtn.click(); });
</script>
</body>
</html>

