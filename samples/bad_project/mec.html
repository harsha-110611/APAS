<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mechanical Before - Flash Card Quiz</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; background: linear-gradient(135deg,#0d0d0d,#1a1a1a); font-family:'Poppins',sans-serif; overflow:hidden; }
canvas { display:block; }

#beforeScreen { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; display:flex; align-items:center; justify-content:center; width:80%; max-width:750px; }
.cinematic-panel { background: rgba(255,255,255,0.9); border-radius:50px; padding:40px 60px; text-align:center; box-shadow:0 10px 35px rgba(0,0,0,0.35); }
.cinematic-text { font-size:18px; line-height:1.8; margin:10px 0; text-align:left; color:black; }

.button { position: relative; transition: all 0.3s ease-in-out; box-shadow:0px 10px 20px rgba(0,0,0,0.2); padding:0.5rem 1.25rem; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; gap:10px; font-weight:bold; border:3px solid #ffffff4d; outline-offset:3px; overflow:hidden; font-size:15px; cursor:pointer; margin-top:25px; user-select:none; display:none; }
#backBtn { background-color:#e74c3c; color:white; }
#startQuizBtn { background-color:#006bb3; color:white; }
.button:hover { transform: scale(1.05); border-color:#fff9; }
.button::before { content:""; position:absolute; width:100px; height:100%; background-image: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.8), rgba(255,255,255,0) 70%); top:0; left:-100px; opacity:0.6; }
.button:hover::before { animation: shine 1.5s ease-out infinite; }
@keyframes shine {0%{left:-100px;} 60%{left:100%;} to{left:100%;}}

/* Roll Number Modal */
#rollModal { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:200; display:none; }
.roll-box { background:#fff; padding:30px 40px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.4); }
.roll-box h2 { margin-bottom:15px; color:#333; }
.roll-box input { padding:10px; border-radius:8px; border:2px solid #ccc; width:80%; font-size:16px; margin-bottom:15px; }
.roll-box button { background:#006bb3; color:white; border:none; padding:10px 20px; border-radius:999px; font-weight:bold; cursor:pointer; position: relative; overflow:hidden; margin-top:10px; }
.roll-box button::before { content:""; position:absolute; width:100px; height:100%; background-image: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.8), rgba(255,255,255,0) 70%); top:0; left:-100px; opacity:0.6; }
.roll-box button:hover::before { animation: shine 1.5s ease-out infinite; }
#userDetails { margin-top:15px; font-weight:bold; color:#333; }
#proceedBtn { display:none; margin-top:10px; }
</style>
</head>
<body>
<canvas id="mech"></canvas>

<div id="beforeScreen">
  <div class="cinematic-panel">
    <h1 id="cinematicHeading"></h1>
    <div id="rulesContainer"></div>
    <div style="display:flex; gap:15px; justify-content:center; margin-top:25px;">
      <button class="button" id="backBtn">‚Üê Back</button>
      <button class="button" id="startQuizBtn">Start Quiz ‚Üí</button>
    </div>
  </div>
</div>

<div id="rollModal">
  <div class="roll-box">
    <h2>Enter Your Roll Number</h2>
    <input type="text" id="rollInput" placeholder="e.g. 24F11A05XX" />
    <br/>
    <button id="submitRollBtn">Submit</button>
    <button id="proceedBtn">Proceed to Quiz ‚Üí</button>
    <p id="userDetails"></p>
  </div>
</div>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ---------- Supabase setup ----------
const supabaseUrl = "https://vjbdemwrqalpnjbjfsir.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqYmRlbXdycWFscG5qYmpmc2lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMjEzODgsImV4cCI6MjA3MTc5NzM4OH0.yigzQuQcI-MbHSYV04MZFoCp9iAYcIF2cGO2VMFgdfs";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
const roll_no = localStorage.getItem("roll_no"); 

// ===== Function to update score & attempts in Supabase =====
async function updateUserScoreAndAttempts(roll_no, current_score) {
  try {
    // 1. Fetch current user data
    let { data: userData, error: fetchError } = await supabaseClient
      .from("users")
      .select("total_score, attempts")
      .eq("roll_no", roll_no)
      .single();

    if (fetchError) {
      console.error("‚ùå Error fetching user data:", fetchError);
      return;
    }

    // 2. Update total_score and attempts
    const newScore = (userData.total_score || 0) + current_score;
    const newAttempts = (userData.attempts || 0) - 1;

    let { error: updateError } = await supabaseClient
      .from("users")
      .update({ total_score: newScore, attempts: newAttempts })
      .eq("roll_no", roll_no);

    if (updateError) {
      console.error("‚ùå Error updating user data:", updateError);
    } else {
      console.log("‚úÖ Score and attempts updated:", { newScore, newAttempts });
    }
  } catch (err) {
    console.error("Unexpected error:", err);
  }
}
</script>

<script>
// ‚öôÔ∏è Mechanical bolts background (unchanged)
const canvas = document.getElementById("mech"), ctx = canvas.getContext("2d");
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
resize(); window.addEventListener("resize", resize);

class Bolt {
  constructor(){ this.reset(); }
  reset(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.size=20+Math.random()*20; this.angle=Math.random()*Math.PI*2; this.speed=0.002+Math.random()*0.004; this.color=Math.random()<0.5?"#ffaa00":"#00e6e6"; }
  draw(time){ ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.angle+time*this.speed); ctx.beginPath();
    for(let i=0;i<6;i++){ let theta=(i*Math.PI)/3; let px=Math.cos(theta)*this.size; let py=Math.sin(theta)*this.size; i===0?ctx.moveTo(px,py):ctx.lineTo(px,py); }
    ctx.closePath(); ctx.strokeStyle=this.color; ctx.lineWidth=3; ctx.shadowBlur=15; ctx.shadowColor=this.color; ctx.stroke(); ctx.restore(); }
}
let bolts=[]; for(let i=0;i<40;i++) bolts.push(new Bolt());
function animate(time){ ctx.clearRect(0,0,canvas.width,canvas.height); bolts.forEach(b=>b.draw(time)); requestAnimationFrame(animate); }
animate(0);

// üé¨ Rules typing (unchanged)
const heading=document.getElementById("cinematicHeading");
const container=document.getElementById("rulesContainer");
const startBtn=document.getElementById("startQuizBtn");
const backBtn=document.getElementById("backBtn");

function typeWriter(el,text,speed,cb){ el.innerHTML=''; let i=0; function typing(){ if(i<text.length){ el.innerHTML+=text.charAt(i); i++; setTimeout(typing,speed);} else if(cb) cb(); } typing(); }

const rules=[
  "1. The user will have five questions.",
  "2. For each correct answer, the player will be awarded 2 points.",
  "3. For each incorrect answer, no points will be awarded.",
  "4. As for now the points are stored in the local storage,we will furtherly update them in a well defined DATA-BASE.",
  "5. For the user convenience and fun,user can play the QUIZ even they are out of attempts."
];

typeWriter(heading,"Before We Begin",100,function showRules(index=0){
  if(index<rules.length){
    const p=document.createElement("p"); p.className="cinematic-text"; container.appendChild(p);
    typeWriter(p,rules[index],40,()=>{ setTimeout(()=>showRules(index+1),400); });
  } else { startBtn.style.display='inline-flex'; backBtn.style.display='inline-flex'; }
});

backBtn.onclick = () => {
  window.location.href = "departments.html";
};

// ---------- Roll Modal + Supabase integration ----------
const rollModal = document.getElementById('rollModal');
const rollInput = document.getElementById('rollInput');
const submitBtn = document.getElementById('submitRollBtn');
const proceedBtn = document.getElementById('proceedBtn');
const userDetails = document.getElementById('userDetails');

startBtn.onclick = ()=> rollModal.style.display = "flex";

submitBtn.onclick = async () => {
  const roll = rollInput.value.trim().toUpperCase();
  if(!roll){ alert("Please enter your roll number."); return; }

  // try fetch existing user (single returns error when no rows)
  const { data: existing, error: selectError } = await supabase
    .from('users')
    .select('*')
    .eq('roll_number', roll)
    .single();

  // if some error happened other than "no rows"
  if (selectError && selectError.code !== 'PGRST116') {
    console.error('Select error:', selectError);
    alert('Database error. Check console.');
    return;
  }

  if (!existing) {
    // insert new user with default attempts = 5 (points start at 0)
    const { error: insertError } = await supabase
      .from('users')
      .insert([{ roll_number: roll, points: 0, attempts: 5 }]);

    if (insertError) {
      console.error('Insert error:', insertError);
      alert('Error creating user.');
      return;
    }

    userDetails.textContent = `Roll Number: ${roll} | Points: 0 | Attempts: 5`;
  } else {
    userDetails.textContent = `Roll Number: ${roll} | Points: ${existing.points} | Attempts: ${existing.attempts}`;
  }

  proceedBtn.style.display = 'inline-block';
};

proceedBtn.onclick = () => {
  localStorage.setItem('rollNumber', rollInput.value.trim().toUpperCase());
  window.location.href = 'mech-quiz.html';
};

rollInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') submitBtn.click(); });
</script>
</body>
</html>

